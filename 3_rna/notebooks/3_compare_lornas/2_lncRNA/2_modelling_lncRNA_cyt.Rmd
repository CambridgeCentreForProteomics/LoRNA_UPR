---
title: "Modelling features driving cytosolic localisation of lncRNAs"
author:
  - name: "Tom Smith"
    affiliation: "Cambridge Centre for Proteomics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: | 
  Here, we model the features contributing to the cytosolic localisation of lncRNAs
output:
  pdf_document:
  html_notebook: default
geometry: margin=1in
fontsize: 11pt
---

```{r}
library(camprotR)
library(tidyverse)
library(MSnbase)
library(biomaRt)
library(glmnet)

```

Read in the features
```{r}
transcript_features <- readRDS('./out/lncRNA_cyt_proportion_features.rds') %>%
  dplyr::select(-c(ensembl_transcript_id, ensembl_gene_id, gene_biotype))
transcript_features <- transcript_features %>% filter(is.finite(TPM))
transcript_features$transcript_length <- log10(transcript_features$transcript_length)
```

Binarise the cytosol localisation
```{r}
transcript_features_binary <- transcript_features %>% filter((Cytosol>2/3|Cytosol<1/3))
nrow(transcript_features)
nrow(transcript_features_binary)
dim(transcript_features_binary)

```
Create training and test data
```{r}
set.seed(0)

train <- sample(1:nrow(transcript_features_binary), size=nrow(transcript_features_binary)*0.8)
test <- setdiff(1:nrow(transcript_features_binary), train)
print(dim(transcript_features_binary))
```
```{r}

set.seed(0)

features_binary <- transcript_features_binary[train,] %>% dplyr::select(-Cytosol)

Cytosol_binary <- transcript_features_binary[train, 'Cytosol']
Cytosol_binary <- as.numeric(Cytosol_binary>0.5)

set.seed(0)
nfolds <- 10
foldid_binary <- sample(rep(seq_len(nfolds), length=nrow(features_binary)))
alphas <- seq(0, 1, len=11)

```

Run elastic net
```{r, eval=FALSE}
cv.elasticnet_binary <- alphas %>% lapply(function(alpha){
  cv.glmnet(data.matrix(features_binary),
            Cytosol_binary,
            alpha = alpha,
            family = "binomial",
            foldid=foldid_binary,
            trace.it=TRUE)
})

saveRDS(cv.elasticnet_binary, './out/cv.elasticnet_binary_lncRNA_features.rds')

```

Assess alpha and penalisation parameters.
```{r, fig.height=10, fig.width=10}
cv.elasticnet_binary <- readRDS('./out/cv.elasticnet_binary_lncRNA_features.rds')

par(mfrow = c(4, 3), mar=c(4,4,5.5,1))
cv.elasticnet_binary %>% lapply(plot)


```
Identify optimal apha
```{r}
min_cvms <- unlist(lapply(cv.elasticnet_binary, function(x) min(x$cvm))) 
print(min_cvms)
plot(min_cvms)
best <- which.min(min_cvms)
optimal_alpha <- alphas[best]
print(optimal_alpha)
```

```{r}
optimal_glmnet_fit <- cv.elasticnet_binary[[best]]
plot(optimal_glmnet_fit)

```

ROC for hold out test data.
```{r}
newX <- transcript_features_binary[test,] %>% dplyr::select(-Cytosol)
pred <- 1-predict(optimal_glmnet_fit,
                newx=data.matrix(newX), s='lambda.1se', type='response')

obs <- transcript_features_binary[test, 'Cytosol']
max_pred_obs <- max(c(pred, obs))
min_pred_obs <- min(c(pred, obs))

pred_obs <- data.frame(pred=pred[,1],
                       obs,
                       row.names=rownames(transcript_features_binary)[test]) %>%
  mutate(is_cyt=obs>2/3)



```


```{r}
library(pROC)
g <- roc(is_cyt ~ pred, data = pred_obs)
print(g)

ggplot(data.frame(x=g$specificities, y=g$sensitivities),
       aes(x,y)) +
  geom_abline(slope=1, size=0.5, colour='grey', intercept=1) +
  geom_step() +
  scale_x_reverse() +
  theme_camprot(border=FALSE) +
  xlab('Specificity') +
  ylab('Sensitivity')
  

plot(g, add=FALSE, xlim=c(1,0), ylim=c(0,1), identity=FALSE)

```
What about a simpler model with just transcript length, polyA and AU content? Let's train and then apply to test data
```{r}


simple_coef <- c('transcript_length', 'AU_content', 'polyadenylation')
simple_in_data <- transcript_features_binary[train,] %>%
  dplyr::select(Cytosol, all_of(simple_coef))

simple_in_data[,simple_coef] <- scale(simple_in_data[,simple_coef])

simple_glm_fit <- glm(formula=sprintf('Cytosol ~ %s', paste(simple_coef, collapse='+')),
                      data=simple_in_data,
                      family = "binomial")

summary(simple_glm_fit)

simple_newX <- transcript_features_binary[test,] %>%
  dplyr::select(all_of(simple_coef)) %>%
  scale() %>%
  data.frame()

dim(simple_newX)
simple_pred <- predict(simple_glm_fit, newdata=simple_newX, type='response')
length(simple_pred)
length(obs)

simple_pred_obs <- data.frame(pred=simple_pred, obs, row.names=rownames(transcript_features_binary)[test]) %>%
  mutate(is_cyt=obs>2/3)


simple_g <- roc(is_cyt ~ pred, data = simple_pred_obs)
print(simple_g)

p <- bind_rows(data.frame(x=1-g$specificities, y=g$sensitivities, type='All'),
          data.frame(x=1-simple_g$specificities, y=simple_g$sensitivities, type='Simple')) %>%
  arrange(y) %>%
  ggplot(aes(x,y, colour=type)) +
  #geom_abline(slope=1, size=0.5, colour='grey', intercept=1, linetype=2) +
  geom_step(size=0.5) +
  #scale_x_reverse() +
  theme_camprot(border=FALSE, base_size=15, base_family='sans') +
  xlab('False positive rate') +
  ylab('True positive rate') +
  scale_colour_manual(values=c('grey20', get_cat_palette(7)[7]), name='Features\nconsidered') +
  theme(legend.position=c(1,0.1), legend.justification=c(1,0))
  
print(p)
ggsave('../../../../5_manuscript_figures/Figure_3/lncRNA_model/ROC.png', width=3.5, height=3.5)
ggsave('../../../../5_manuscript_figures/Figure_3/lncRNA_model/ROC.pdf', width=3.5, height=3.5)
```
OK, so there's really very little difference between the two models. Both have ROC=0.86. On this basis, the simpler model should be preferred as likely to be more generalisable.

Let's plot the coefficients from the simple model.
```{r}
coefficients <- summary(simple_glm_fit)$coefficients %>% data.frame() %>% tibble::rownames_to_column('feature')

library(ggrepel)
p <- coefficients %>% 
  filter(feature!='(Intercept)') %>%
  mutate(feature=recode(feature,
                        'polyadenylation'='PolyA',
                        'AU_content'='AU content',
                        'transcript_length'='Transcript length')) %>%
  arrange(Estimate) %>%
  mutate(feature=factor(feature, levels=feature)) %>%
  ggplot(aes(y=-log10(Pr...z..), Estimate, label=feature)) +
  geom_point(size=5) +
  geom_vline(xintercept=0, colour='grey', linetype=2, size=0.25) +
  geom_text_repel(segment.size=0,
                  segment.colour=NA,
                  point.padding=unit(5, 'mm'),
                  size=4,
                  colour=get_cat_palette(1),
                  xlim=c(-0.6, 0.5)) +
  theme_camprot(border=FALSE, base_family='sans', base_size=15) +
  xlab('Standardised coefficient') +
  ylab('- Log10(p-value)') +
  xlim(-0.75, 0.5) +
  annotate(geom='segment', x=0.1, xend=0.5, y=8, yend=8, size=1,
           arrow = arrow(type='closed', length = unit(.3,"cm"))) +
  annotate(geom='segment', x=-0.1, xend=-0.5, y=8, yend=8, size=1,
           arrow = arrow(type='closed', length = unit(.3,"cm"))) +
  annotate(geom='text', label='More cytosolic', x=0.3, y=8.5, size=4) +
  annotate(geom='text', label='Less cytosolic', x=-0.3, y=8.5, size=4)

print(p)

ggsave('../../../../5_manuscript_figures/Figure_3/lncRNA_model/coefficients.png', width=3.5, height=3.5)
ggsave('../../../../5_manuscript_figures/Figure_3/lncRNA_model/coefficients.pdf', width=3.5, height=3.5)
```