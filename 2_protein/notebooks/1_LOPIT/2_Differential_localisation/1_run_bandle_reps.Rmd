---
title: "Differential protein localisation"
author:
  - name: "Tom Smith"
    affiliation: "Cambridge Centre for Proteomics"
date: "`r format(Sys.time(), '%d %B, %Y')`"
abstract: | 
  Here, we run BANDLE (once per replicate) to identify proteins with differential localisation
output:
  pdf_document:
  html_notebook: default
geometry: margin=1in
fontsize: 11pt
---

```{r}
library(MSnbase)
library(pRoloc)
library(pRolocExt)
library(bandle)
library(dplyr)
library(tidyr)
library(ggplot2)
library(camprotR)
library(tidyverse)


```


We'll follow the step laid out in the `bandle-vignette-getting-started` vignette.

First, we need to load the input data.
```{r}
combined_protein_res <- readRDS('../../results/combined_protein_res_with_tsne.rds')
```

The input is a list of two MSnSets, one for each condition. We'll filter these to remove proteins with any NAs (note these are mainly missing in a whole replicate, as shown in previous notebook) and then make sure the MSnSets contain the same common proteins.
```{r}


combined_protein_res %>% lapply(dim)

combined_protein_res$DMSO <- combined_protein_res$DMSO %>% filterNA()
combined_protein_res$Thapsigargin <- combined_protein_res$Thapsigargin %>% filterNA()

combined_protein_res %>% lapply(dim)

common_proteins <- intersect(rownames(combined_protein_res$DMSO),
                             rownames(combined_protein_res$Thapsigargin))

combined_protein_res <- combined_protein_res %>% lapply(function(x) x[common_proteins,])

combined_protein_res %>% lapply(dim)

```
```{r}
saveRDS(combined_protein_res, '../../out/combined_protein_res_for_bandle.rds')
```


Following the bandle vignette, we need to convert our MSnSets for each condition into one list of 2 MsnSets (1 per conditions)
```{r, fig.height=8, fig.width=8, eval=FALSE}
bandleres_reps <- 1:3 %>% lapply(function(rep){
  dmso <- combined_protein_res$DMSO[,pData(combined_protein_res$DMSO)$replicate==rep]
  tg <- combined_protein_res$Thapsigargin[,pData(combined_protein_res$Thapsigargin)$replicate==rep]
  
  plot2D(dmso, main = paste('DMSO', rep, sep=' - '), grid = FALSE)
  addLegend(combined_protein_res$DMSO, where = "bottomright", cex = 0.5)
  
  plot2D(dmso, main = paste('DMSO', rep, sep=' - '), dims=c(3,4), grid = FALSE)
  addLegend(combined_protein_res$DMSO, where = "bottomright", cex = 0.5)
  
  plot2D(tg, main = paste('Thapsigargin', rep, sep=' - '), grid = FALSE)
  addLegend(combined_protein_res$Thapsigargin, where = "bottomright", cex = 0.5)
  
  plot2D(tg, main = paste('Thapsigargin', rep, sep=' - '), dims=c(3,4), grid = FALSE)
  addLegend(combined_protein_res$Thapsigargin, where = "bottomright", cex = 0.5)

  dLOPIT <- list(dmso, tg)
  
  set.seed(1)
  K <- length(getMarkerClasses(dLOPIT[[1]]))
  
  pc_prior <- matrix(NA, ncol = 3, K)
  pc_prior[seq.int(1:K), ] <- matrix(rep(c(1, 50, 50),
                                         each = K), ncol = 3)
  
  
  par(mfrow = c(3,4))
  gpParams <- lapply(dLOPIT, function(x) fitGPmaternPC(x, hyppar = pc_prior))
  
  set.seed(0)
  dirPrior = diag(rep(1, K)) + matrix(0.01, nrow = K, ncol = K)
  predDirPrior <- prior_pred_dir(object = dLOPIT[[1]],
                                 dirPrior = dirPrior,
                                 q = 50)
  predDirPrior$meannotAlloc
  predDirPrior$tailnotAlloc

  par(mfrow=c(1,1))
  hist(predDirPrior$priornotAlloc, col = getStockcol()[1])
  
  multicoreParam <- MulticoreParam(workers = 4)
  start <- Sys.time()
  control <- dLOPIT[1]
  treatment <- dLOPIT[2]
  bandleres <- bandle(objectCond1 = control,
                      objectCond2 = treatment,
                      numIter = 1E4,
                      burnin = 5E3,
                      thin = 20,
                      gpParams = gpParams,
                      numChains = 4,
                      dirPrior = dirPrior,
                      pcPrior = pc_prior,
                      BPPARAM = MulticoreParam())
  
  
  end <- Sys.time()
  
  bandleres <- bandleProcess(bandleres)
  print(end-start)
  
  return(bandleres)
})

saveRDS(bandleres_reps, '../../out/bandleres_reps.rds')
```

```{r}
bandleres_reps <- readRDS('../../out/bandleres_reps.rds')
```

Checking for convergence based on consistent number of outliers, as per the vignette discussing TAGM-MCMC. Note, this is post thinning.
```{r}
par(mfrow = c(2,2))

bandleres_reps %>% lapply(function(rep){
  rep@chains@chains %>% lapply(
  function(x){
    non_outliers <- x@outlier$cond1 %>% colSums() 
    plot(nrow(x@outlier$cond1)-non_outliers, ylab='Outliers', cex=0.1)
    })
})
```

For each rep, the chains all appear to have converged OK, with a reasonable number of outliers. Fewer than running all replicates together
```{r}
bandleres_reps %>% lapply(function(rep){
  pe1 <- summaries(rep)[[1]]@posteriorEstimates
  plot(pe1$bandle.differential.localisation[order(pe1$bandle.differential.localisation, decreasing = TRUE)],
       col = getStockcol()[3], pch = 19, ylab = "Probability", xlab = "Rank", main = "Differential localisation rank plot")
})
```


```{r}
par(mfrow = c(1, 2))

bandleres_reps %>% lapply(function(rep){
  pe1_conf <- summaries(rep)[[1]]@posteriorEstimates %>%
    data.frame() %>%
    filter(bandle.outlier==0, bandle.probability.lowerquantile>0.99)
  
  barplot(table(pe1_conf$bandle.allocation), col = getStockcol()[2], las = 2, main = "Protein allocation: control")
  
  pe2_conf <- summaries(rep)[[2]]@posteriorEstimates %>%
    data.frame() %>%
    filter(bandle.outlier==0, bandle.probability.lowerquantile>0.99)
  
  barplot(table(pe2_conf$bandle.allocation), col = getStockcol()[2], las = 2, main = "Protein allocation: treatment")
})
```



What above the outliers - where are they in the projections?
```{r}
1:3 %>% lapply(function(rep){
  
  outliers_cond1 <- summaries(bandleres_reps[[rep]])[[1]]@posteriorEstimates %>%
    data.frame() %>%
    filter(bandle.outlier>0.5) %>% rownames()
  
  .data <- combined_protein_res[[1]][,pData(combined_protein_res[[1]])$replicate==rep] 
  
  pca <- plot2D(.data)
  addLegend(.data, where='bottomright', cex=0.7)
  highlightOnPlot(pca, foi=outliers_cond1)
  
  pca <- plot2D(.data, dims=c(3,4))
  addLegend(.data, where='bottomright', cex=0.7)
  highlightOnPlot(pca, foi=outliers_cond1)
})
```

Below, we extract the posterior estimates and add columns for the probability of localisation including outlier probability and the allocation, allowing for this to be undefined when probability of localisation is <= 0.95.
```{r}

get_pe <- function(n){
  1:3 %>% lapply(function(rep){
    summaries(bandleres_reps[[rep]])[[n]]@posteriorEstimates %>% 
      data.frame() %>%
      mutate(replicate=rep,
             bandle.probability.inc.outlier=bandle.probability*(1-bandle.outlier),
             bandle.allocation.inc.undefined=ifelse(bandle.probability.inc.outlier>0.95,
                                                    bandle.allocation, 'Undefined')) %>%
      tibble::rownames_to_column('protein')
  }) %>% bind_rows()
  
}

dmso_pe <- get_pe(1)
tg_pe <- get_pe(2)


keep_cols_dmso <- c('replicate',
                    'protein',
                    'bandle.allocation',
                    'bandle.probability',
                    'bandle.outlier',
                    'bandle.allocation.inc.undefined',
                    'bandle.probability.inc.outlier',
                    'bandle.differential.localisation')

keep_cols_tg <- setdiff(keep_cols_dmso, 'bandle.differential.localisation')

combined_pe <- left_join(dmso_pe[,keep_cols_dmso], 
                         tg_pe[,keep_cols_tg],
                         by=c('protein', 'replicate'),
                         suffix=c('_DMSO', '_Tg'))

```

Save for downstream notebooks
```{r}
saveRDS(combined_pe, '../../out/combined_pe.rds')
```


